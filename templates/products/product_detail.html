{% extends 'base.html' %}
{% load static %}

{% block title %}{% if product %}{{ product.name }}{% else %}Product{% endif %} - ClothVerse{% endblock %}

{% block content %}
<main class="py-16 md:py-24 bg-neutral/50 animate-fade-in">
    <div class="max-w-7xl mx-auto px-4">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
            <!-- Product Images -->
            <div class="space-y-4">
                <!-- Main Image -->
                <div class="w-full max-w-md mx-auto bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="aspect-[4/5] relative">
                        {% if product.images.first %}
                            <img id="main-image" src="{{ product.images.first.image.url }}" alt="{{ product.name }}" class="w-full h-full object-cover">
                        {% else %}
                            <div class="w-full h-full bg-gray-200 flex items-center justify-center">
                                <i data-lucide="image" class="w-16 h-16 text-gray-400"></i>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Thumbnail Images - Show 4 -->
                <div class="grid grid-cols-4 gap-3 max-w-md mx-auto" id="thumbnail-container">
                    {% for image in product.images.all|slice:":4" %}
                        <button onclick="changeImage('{{ image.image.url }}', this)" class="thumbnail-btn aspect-square bg-white rounded-lg border-2 {% if forloop.first %}border-primary{% else %}border-gray-200{% endif %} hover:border-primary transition-colors overflow-hidden">
                            <img src="{{ image.image.url }}" alt="{{ product.name }} thumbnail {{ forloop.counter }}" class="w-full h-full object-cover">
                        </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Product Information -->
            <div class="space-y-6">
                <!-- Breadcrumb -->
                <nav class="text-sm text-gray-600">
                    <a href="{% url 'home' %}" class="hover:text-primary">Home</a>
                    <span class="mx-2">/</span>
                    <a href="{% url 'product_list' %}" class="hover:text-primary">Products</a>
                    {% if product and product.category %}
                        <span class="mx-2">/</span>
                        <a href="{% url 'category_products' product.category.id %}" class="hover:text-primary">{{ product.category.name }}</a>
                    {% endif %}
                    <span class="mx-2">/</span>
                    <span class="text-dark">{% if product %}{{ product.name }}{% else %}Product{% endif %}</span>
                </nav>

                <!-- Product Title and Brand -->
                <div>
                    {% if product and product.brand %}
                        <span class="text-sm text-gray-500 uppercase tracking-wide">{{ product.brand.name }}</span>
                    {% endif %}
                    <h1 class="font-serif text-3xl text-dark mt-2">{% if product %}{{ product.name }}{% else %}Product{% endif %}</h1>
                </div>

                <!-- Price -->
                <div class="flex items-center gap-4">
                    <span class="text-3xl font-semibold text-dark">{% if product %}₹{{ product.price }}{% else %}₹0.00{% endif %}</span>
                    {% if product and product.original_price and product.original_price > product.price %}
                        <span class="text-xl text-gray-500 line-through">₹{{ product.original_price }}</span>
                        <span class="bg-red-100 text-red-700 px-2 py-1 rounded text-sm font-medium">
                            {{ product.discount_percentage }}% OFF
                        </span>
                    {% endif %}
                </div>

                <!-- Product Description -->
                <div>
                    <h3 class="font-medium text-dark mb-2">Description</h3>
                    <p class="text-gray-600 leading-relaxed">{% if product %}{{ product.description }}{% else %}Product description will appear here.{% endif %}</p>
                </div>

                <!-- Size Selection -->
                {% if product and product.sizes.all %}
                <div class="py-4 border-y border-gray-200">
                    <div>
                        <span class="block text-sm font-medium text-gray-700 mb-3">Size</span>
                        <div class="flex flex-wrap gap-2">
                            {% for size in product.sizes.all %}
                                <button type="button" onclick="selectSize('{{ size.name }}')" class="size-btn px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium hover:border-primary hover:text-primary transition-colors" data-size="{{ size.name }}">
                                    {{ size.name }}
                                </button>
                            {% endfor %}
                        </div>
                        <input type="hidden" id="selected_size" name="size" value="">
                    </div>
                </div>
                {% endif %}

                <!-- Add to Cart Form -->
                {% if product %}
                <form method="post" action="{% url 'add_to_cart' product.id %}" class="space-y-4">
                    {% csrf_token %}

                    <!-- Quantity Selector -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                        <div class="flex items-center gap-3">
                            <button type="button" onclick="decrementQuantity()" class="w-10 h-10 border border-gray-300 rounded-lg flex items-center justify-center hover:bg-gray-50">
                                <i data-lucide="minus" class="w-4 h-4 text-gray-600"></i>
                            </button>
                            <input type="number" id="quantity" name="quantity" value="1" min="1" class="w-20 text-center border border-gray-300 rounded-lg py-2 px-3 focus:ring-2 focus:ring-primary focus:border-transparent">
                            <button type="button" onclick="incrementQuantity()" class="w-10 h-10 border border-gray-300 rounded-lg flex items-center justify-center hover:bg-gray-50">
                                <i data-lucide="plus" class="w-4 h-4 text-gray-600"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 inline-flex items-center justify-center rounded-full font-medium transition-all active:scale-95 bg-accent hover:bg-[#E85A50] text-white px-8 py-4 text-base">
                            <i data-lucide="shopping-bag" class="w-5 h-5 mr-2"></i>
                            Add to Cart
                        </button>
                        <button type="button" class="p-4 border border-gray-300 rounded-full hover:bg-gray-50 transition-colors">
                            <i data-lucide="heart" class="w-5 h-5 text-gray-600"></i>
                        </button>
                    </div>
                </form>
                {% endif %}

                <!-- Additional Info -->
                <div class="space-y-4 text-sm text-gray-600">
                    <div class="flex items-center gap-2">
                        <i data-lucide="truck" class="w-4 h-4"></i>
                        <span>Free shipping on orders over ₹999</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                        <span>Easy 15-day returns</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i data-lucide="shield" class="w-4 h-4"></i>
                        <span>Secure payment</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // On page load, ensure the first thumbnail has the primary border.
    // This is needed because we are now combining product.image and product.images.all
    const thumbnailContainer = document.getElementById('thumbnail-container');
    if (thumbnailContainer && thumbnailContainer.children.length > 0) {
        thumbnailContainer.querySelectorAll('.thumbnail-btn').forEach(btn => btn.classList.remove('border-primary'));
        thumbnailContainer.children[0].classList.add('border-primary');
    }
});

function changeImage(imageUrl, clickedButton) {
    document.getElementById('main-image').src = imageUrl;
    document.getElementById('selected_image_url').value = imageUrl;
    // Update thumbnail borders
    document.querySelectorAll('.thumbnail-btn').forEach(btn => {
        btn.classList.remove('border-primary');
        btn.classList.add('border-gray-200');
    });
    // Add active border to the clicked thumbnail
    clickedButton.classList.remove('border-gray-200');
    clickedButton.classList.add('border-primary');
}

function selectSize(size) {
    // Remove selected class from all size buttons
    document.querySelectorAll('.size-btn').forEach(btn => {
        btn.classList.remove('border-primary', 'text-primary', 'bg-primary/5');
        btn.classList.add('border-gray-300', 'text-gray-700');
    });

    // Add selected class to clicked button
    event.target.classList.remove('border-gray-300', 'text-gray-700');
    event.target.classList.add('border-primary', 'text-primary', 'bg-primary/5');

    // Set hidden input value
    document.getElementById('selected_size').value = size;
}

function incrementQuantity() {
    const quantityInput = document.getElementById('quantity');
    quantityInput.value = parseInt(quantityInput.value) + 1;
}

function decrementQuantity() {
    const quantityInput = document.getElementById('quantity');
    const currentValue = parseInt(quantityInput.value);
    if (currentValue > 1) {
        quantityInput.value = currentValue - 1;
    }
}
</script>
{% endblock %}